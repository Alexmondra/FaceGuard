<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reconocimiento Facial</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <script src="https://cdn.socket.io/4.4.0/socket.io.min.js"></script>
  </head>
  <body>
    <h1>Sistema de Reconocimiento Facial</h1>
    <div>
      <button id="liveButton">Actualizar Cámaras</button>
      <span id="status">Sincronizando...</span>
      <span id="nextUpdate"></span>
    </div>
    <h2>Cámaras Activas</h2>
    <div id="camerasContainer" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
    
    <script>
      const serverUrl = "http://127.0.0.1:5000";
      const socket = io.connect(serverUrl, {
        reconnection: true,
        reconnectionAttempts: 10,
        reconnectionDelay: 2000,
        timeout: 20000,
        transports: ["websocket"],
      });
      
      let updateInterval;
      let countdown = 30;
      
      socket.on("connect", () => {
        console.log("Conexión establecida con el servidor");
        document.getElementById("status").textContent = "Conectado";
        // Iniciar verificación automática al conectar
        iniciarVerificacionAutomatica();
      });
      
      socket.on("disconnect", () => {
        console.warn("Conexión perdida, intentando reconectar...");
        document.getElementById("status").textContent = "Desconectado - Reconectando...";
        clearInterval(updateInterval); // Detener el intervalo cuando perdemos conexión
      });
      
      // Función para agregar una cámara al DOM
      function agregarCamara(camara) {
        const camerasContainer = document.getElementById("camerasContainer");
        
        // Verificar que la cámara esté activa
        if (camara.estado === "Activo") {
          // Evitar agregar duplicados - si ya existe, no la añadimos de nuevo
          if (document.getElementById(`camera_${camara.id}`)) return;
          
          const camDiv = document.createElement("div");
          camDiv.id = `container_camera_${camara.id}`;
          camDiv.style.border = "2px solid black";
          camDiv.style.padding = "10px";
          camDiv.style.textAlign = "center";
          camDiv.innerHTML = `<h3>${camara.nombre}</h3>
                             <img id="camera_${camara.id}" width="320" height="240" style="border: 1px solid gray;">`;
          camerasContainer.appendChild(camDiv);
          
          // Suscribirse al canal de video para esa cámara
          socket.on(`video_frame_${camara.id}`, (data) => {
            const imgElement = document.getElementById(`camera_${camara.id}`);
            if (imgElement) {
              imgElement.src = "data:image/jpeg;base64," + data.frame;
            }
          });
        } else {
          // Si la cámara no está activa, removerla si existe
          removerCamara(camara.id);
        }
      }
      
      // Función para remover la cámara del DOM
      function removerCamara(id) {
        const container = document.getElementById(`container_camera_${id}`);
        if (container) {
          container.remove();
        }
      }
      
      // Función para cargar todas las cámaras iniciales
      async function cargarCamaras() {
        try {
          document.getElementById("status").textContent = "Sincronizando...";
          const response = await fetch(`${serverUrl}/camaras_activas`);
          const camaras = await response.json();
          
          // Obtener IDs de todas las cámaras actuales en DOM
          const currentCameras = Array.from(
            document.querySelectorAll('[id^="container_camera_"]')
          ).map(el => parseInt(el.id.replace('container_camera_', '')));
          
          // Agregar nuevas cámaras y actualizar existentes
          camaras.forEach((camara) => {
            agregarCamara(camara);
          });
          
          // Remover cámaras que ya no están activas
          const activeCameraIds = camaras
            .filter(c => c.estado === "Activo")
            .map(c => c.id);
            
          currentCameras.forEach(id => {
            if (!activeCameraIds.includes(id)) {
              removerCamara(id);
            }
          });
          
          document.getElementById("status").textContent = "Conectado";
          
          // Iniciar o continuar la transmisión
          socket.emit("request_video");
          
          return true;
        } catch (error) {
          console.error("Error al cargar las cámaras activas:", error);
          document.getElementById("status").textContent = "Error al sincronizar";
          return false;
        }
      }
      
      // Escuchar el evento para nuevas cámaras
      socket.on("nueva_camara", (camara) => {
        console.log("Nueva cámara detectada:", camara);
        agregarCamara(camara);
      });
      
      // Escuchar el evento cuando una cámara se desconecta
      socket.on("detener_camara", (data) => {
        console.log("La cámara se desconectó:", data);
        removerCamara(data.id);
      });
      
      // Función para iniciar la verificación automática
      function iniciarVerificacionAutomatica() {
        // Cargar las cámaras inicialmente
        cargarCamaras();
        
        // Limpiar intervalo existente si hay uno
        if (updateInterval) {
          clearInterval(updateInterval);
        }
        
        // Actualizar contador
        countdown = 30;
        actualizarContador();
        
        // Establecer nuevo intervalo
        updateInterval = setInterval(() => {
          if (countdown <= 0) {
            cargarCamaras();
            countdown = 30;
          } else {
            countdown--;
          }
          actualizarContador();
        }, 1000);
      }
      
      // Función para actualizar el contador visual
      function actualizarContador() {
        document.getElementById("nextUpdate").textContent = `Próxima actualización en ${countdown} segundos`;
      }
      
      // Iniciar verificación automática al cargar la página
      window.onload = () => {
        // La conexión se maneja en el evento 'connect'
      };
      
      // Mantener el botón para actualización manual
      document.getElementById("liveButton").onclick = () => {
        console.log("Actualizando manualmente...");
        cargarCamaras();
        countdown = 30;
        actualizarContador();
      };
    </script>
  </body>
</html>